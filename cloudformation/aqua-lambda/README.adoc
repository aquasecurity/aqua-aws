:version: 6.0
:imageVersion: 6.0

image:https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png[Launch Stack,link=https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=aqua-serverless&templateURL=https://s3.amazonaws.com/aqua-security-public/{version}/aquaServerless.yaml]

= Description

This page contains instructions for deploying the Aqua serverless audit stack on an Amazon account.

These instructions are applicable to Aqua Enterprise (formerly CSP) Version 5.0 and above.

Your deployment will create these services:
 - SQS: to collect the audit events from Aqua NanoEnforcers
 - Lambda function: to handle and send to audit events to an Aqua gateway

A CloudFormation template is used to deploy the Aqua serverless audit stack. This can be done either with the AWS CloudFormation Management Console or the AWS Command Line interface, as explained below.

== Requirements

From Aqua Security: the ZIP file of the Aqua audit handler Lambda function. You should store it in S3.

== Before deployment

Upload the Aqua audit function to S3.

== Deployment method 1: CloudFormation Management Console

. Click the <b>Launch Stack</b> icon at the top of this page. This will take you to the <b>Create stack</b> function of the AWS CloudFormation Management Console.
. Ensure that your AWS region is set to where you are deploying Aqua Enterprise.
. Click "Next".
. Set or modify any of the parameters (per the explanations provided).
. Click "Next" to create the stack.

It will typically require up to 20 minutes for Aqua Enterprise to be deployed.
When completed, you can obtain the generated `AQUA_SQS_URL` from the outputs tab, under key name `aquaSQSUrl`.

== Deployment method 2: Command Line interface

. Copy the following command:

[source,options="nowrap",subs="attributes"]
----
aws --region us-east-1 cloudformation create-stack --capabilities CAPABILITY_NAMED_IAM \
    --stack-name aqua-serverless-audit --template-body file://aquaServerless.yaml \
    --parameters ParameterKey=AquaGatewayAddress,ParameterValue=x.x.x.x:3622 \
                 ParameterKey=AquaToken,ParameterValue=xxxx \
                 ParameterKey=S3Bucket,ParameterValue=xxxx \ 
                 ParameterKey=S3CodeKey,ParameterValue=xxxx \
----

. Run the AWS create-stack CLI command.

It will typically require up to 20 minutes for your stack to be created and deployed.
When completed, you can obtain the `AQUA_SQS_URL` from the console output, under key name `aquaSQSUrl`.

== Version upgrade

To upgrade your stack, modify the existing stack with the new configuration.